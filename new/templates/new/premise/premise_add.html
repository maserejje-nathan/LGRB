



{% extends 'client/base.html' %} {% block content%}

<!--new stuff goes here -->


<div class="card mt-5">
  <div class="card-body">
    <nav aria-label="breadcrumb" class="d-none d-md-inline-block">
      <ol class="breadcrumb breadcrumb-dark breadcrumb-transparent mb-0">
        <li class="breadcrumb-item">
          <a href="#">
            <svg
              class="icon icon-xxs"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
              xmlns="http://www.w3.org/2000/svg"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"
              ></path>
            </svg>
          </a>
        </li>
        <li class="breadcrumb-item"><a href="#">Premises </a></li>
        <li class="breadcrumb-item active" aria-current="page">
          Premise Licence
        </li>

         <li class="breadcrumb-item active" aria-current="page">
          Application
        </li>
      </ol>
    </nav>
  </div>
</div>

<div class="row">
  <div class="col-12 mb-4">
    <div class="card border-0 shadow">
      <div class="card-header">
        <div class="row align-items-center">
          <div class="col">
            <h2 class="fs-5 fw-bold mb-0">Premise Licence form </h2>
          </div>
          <div class="col text-end">
          
            <a href="{% url 'new:premise_list' %}" class="btn btn-sm btn-primary">view premises </a>
          
            {% comment %} <a class="btn btn btn-sm btn-success show-form"  href="{% url 'payments:payment-premise' %}" > pay for premise </a>
            <a class="btn btn btn-sm btn-success show-form"  href="{% url 'payments:client_premise_payment_list' %}" > view payment records </a>
            <a class="btn btn btn-sm btn-warning show-form"  href="{% url 'payments:premise_pdf_download' %}" > download premises </a> {% endcomment %}

          </div>
        </div>
      </div>
      <div class="table-responsive">
        <!--end task -->
        <div class="card card-body shadow border-0 table-wrapper table-responsive" >
         
          <div class="d-flex mb-3">
            <div class="col-xs-3">
              <input
                type="search"
                class="form-control col-xl-3"
                placeholder="search by company name"
                id="exampleInputIconRight"
              />
            </div>
            <button class="btn btn-sm px-3 btn-secondary ms-3">search</button>
          </div>

          <div class="row mb-3 pb-3">
                <div class="">
                  <!-- Form -->
                    <div class="">  
                        <form method="post" enctype="multipart/form-data" data-url="{% url 'new:create_premise' %}" class="create-form">
                            {% csrf_token %}
                            
                                <div class="row">
                                    <div class=" col-sm">


                                        <div class="">  
                                            {{form.tin.label }} {{form.tin }} 
                                        </div>
                                        
                                      
                                        <div class="">  
                                            {{form.operator_name.label }} {{form.operator_name }} 
                                        </div>

                                     
                                        <div class="">  
                                            {{form.premise_name.label }} {{form.premise_name }} 
                                        </div>

                                        <div class="">  
                                            {{form.location.label }} {{form.location }} 
                                        </div>

                                        <div class="">  
                                            {{form.building_name.label }} {{form.building_name }} 
                                        </div>


                                        <div class="" id="email-div">  
                                            {{form.email.label }} {{form.email }} 
                                        </div>

                                    </div>
                                    <div class="col-sm"> 

                                        

                                    
                                         <div class="">  
                                            {{form.region.label }} {{form.region }} 
                                        </div>
                                        
                                        
                                        <div class="">  
                                            {{form.plot_number.label }} {{form.plot_number }} 
                                        </div>

                                        <div class="">  
                                            {{form.town_council.label }} {{form.town_council }} 
                                        </div>

                                        <div class="">  
                                            {{form.municipality.label }} {{form.municipality }} 
                                        </div>

                                        <div class="">  
                                            {{form.district.label }} {{form.district }} 
                                        </div>

                                    </div>
                                    <div class="col-sm"> 
                                        
                                       <div class="">  
                                            {{form.trade_name.label }} {{form.trade_name }} 
                                        </div>

                                        
                                        <div class="">  
                                            {{form.equipment_in_the_premise.label }} {{form.equipment_in_the_premise }} 
                                        </div>

                                           <div class="">
                                           {{form.inspection_fee.label}} {{form.inspection_fee}}
                                        </div>



                                        <div class="">  
                                            {{form.number_of_gaming_devices.label }} {{form.number_of_gaming_devices }} 
                                        </div>


                                             {% comment %} prn stuff  {% endcomment %}
                                        <div class="mb-4 mt-3 ">
                                            <div class="form-check form-switch">
                                              {{form.generate_prn.label}} 
                                              {{form.generate_prn}}
                                              
                                            </div>
                                            {{form.prn}} 
                                        </div>

                                     
                                        <div class="hidden_div" id="hidden_div">
                                            {{form.error_code}}
                                            {{form.error_desc}}
                                            {{form.payment_expiry_date}}
                                            {{form.search_code}}

                                            {{form.ura_district}}
                                            {{form.ura_county}}
                                            {{form.ura_subcounty}}
                                            {{form.ura_village}}

                                        </div>

                                        
                                   </div>

                                <div class="modal-footer">
                                  <a href="{% url 'new:premise_list' %}" type="button" class="btn btn-secondary">cancel</a> &nbsp;	
                                  <button type="submit" class="btn btn-primary">submit premise</button>
                                </div>
                        </form>
                    </div>
                  <!-- end form -->
                </div>
              </div>
        </div>

        <!--end task -->
      </div>
    </div>
  </div>
</div>





<script type="text/javascript">

    var email_from_client = "{{request.user.email}}"
    var email = $('#email').val(email_from_client);

    $('#email-div').hide()
       $("#hidden_div").hide();


    $(document).ready(function() {


    });



   const tin = document.getElementById('tin');
   tin.addEventListener("change",  function getClientregistration(e){ 
     
        var tin = $("#tin").val();
        var  csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      
        $.ajax({
                url: "{% url 'payments:verify_tin' %}", 
                type: "post",
                data: {
                    "tin": tin,
                },
                dataType: "json",
                headers: {'X-CSRFToken': csrftoken },
                mode: 'same-origin',  
                beforeSend: function () {
                    
                    $('#spinner').show();
                    $("#loading").addClass("loading")
                
                },

                success: function (ura_response) {
                     
                  const response = ura_response
            
                  let val = response[ Object.keys( response )[ 0 ] ]

                  if( Object.keys( val )[ 0 ] === "GetClientRegistrationResult" ) {
                     console.log( '1',val[ 'GetClientRegistrationResult' ] )

                     var status = response.GetClientRegistrationResponse.GetClientRegistrationResult.ErrorDesc
                     var status = response.GetClientRegistrationResponse.GetClientRegistrationResult.ErrorDesc

                     console.log(status)
                     tin_response = {
                        'status': response.GetClientRegistrationResponse.GetClientRegistrationResult.TaxPayerName,
                        'TaxPayerName': response.GetClientRegistrationResponse.GetClientRegistrationResult.TaxPayerName,
                        'ContactNumber': response.GetClientRegistrationResponse.GetClientRegistrationResult.ContactNumber,
                        'MobileNumber': response.GetClientRegistrationResponse.GetClientRegistrationResult.MobileNumber,
                        'TaxPayerEmail': response.GetClientRegistrationResponse.GetClientRegistrationResult.TaxPayerEmail,

                        'ura_district': response.GetClientRegistrationResponse.GetClientRegistrationResult.District,
                        'ura_county': response.GetClientRegistrationResponse.GetClientRegistrationResult.County,
                        'ura_subcounty': response.GetClientRegistrationResponse.GetClientRegistrationResult.SubCounty,
                        'ura_village': response.GetClientRegistrationResponse.GetClientRegistrationResult.Village,

                     }

                     console.log(response);

                     if(status === "SUCCESS"){

                           $("#operator_name").val(tin_response.TaxPayerName);

                           $("#ura_district").val(tin_response.ura_district);
                           $("#ura_county").val(tin_response.ura_county);
                           $("#ura_subcounty").val(tin_response.ura_subcounty);
                           $("#ura_village").val(tin_response.ura_village);


                     } else if (status === "INVALID TIN") {
                  
                           $("#tin").val('');
                           $('#gernerate_prn').prop('checked', false)
                           $("#prn").val('');
                           swal.fire(status);
                           $('.prnError').html('');

                     } else if(status === "Invalid Length of TIN Entered, please try again"){

                           swal.fire(status);

                     } else{

                           $("#tin").val('');
                           $("#name_of_the_company").val('');

                     }
                     
                  } 
                  else {
                        console.log( '2',val )
                        console.log( '2',val[ 'GetClientRegistrationResult' ] )
                   
                        tin_response = {
                           'status': val.ErrorDesc,
                           'TaxPayerName': val.TaxPayerName,
                           'ContactNumber': val.ContactNumber,
                           'MobileNumber': val.MobileNumber,
                           'TaxPayerEmail': val.TaxPayerEmail,

                          
                        }

                        console.log(tin_response);

                        if(tin_response.status === "SUCCESS"){

                              $("#name_of_the_company").val(tin_response.TaxPayerName);

                        } else if (status === "INVALID TIN") {
                     
                              $("#tin").val('');
                              $('#gernerate_prn').prop('checked', false)
                              $("#prn").val('');
                              swal.fire(status);
                              $('.prnError').html('');

                        } else if(status === "Invalid Length of TIN Entered, please try again"){

                              swal.fire(status);

                        } else{

                              $("#tin").val('');
                              $("#name_of_the_company").val('');

                        }
                     
                  }
 
                
                },

                error: function(response) {
                    console.log(response);
                    $('.prnError').html("Invalid PRN. Try later");
                    console.log(response)
                },

                complete: function (response) {

                    $('#spinner').hide();
                    $("#loading").removeClass("loading")
                
                },

        });
   });


   const generateprn = document.getElementById('generate_prn');
   generateprn.addEventListener("click", async function generatePaymentRegistrationNumber(e){

      const principle_licence_certificate_number  = document.getElementById('principle_licence_certificate_number');
      const generate_prn  = document.getElementById('generate_prn').value
      const prn  = document.getElementById('prn').value
      const error_code  = document.getElementById('error_code').value
      const error_desc  = document.getElementById('error_desc').value
      const payment_expiry_date  = document.getElementById('payment_expiry_date').value
      const search_code  = document.getElementById('search_code').value
      const tin = document.getElementById('tin').value
      const inspection_fee = document.getElementById("inspection_fee").value
      const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
      const inspection_fee_url = "{% url 'payments:get_prn_inspection_fee' %}"


      if( tin === ''){
         Swal.fire({
               icon: 'error',
               title: 'Error',
               text: 'TIN field can not be empty',
               showConfirmButton: true,
         })

         document.getElementById("generate_prn").checked = false;

      }


      if(generateprn.checked == true){
        
            $.ajax({
                  url: inspection_fee_url, 
                  type: "post",
                  data: {
                     "inspection_fee": inspection_fee,
                     "tin": tin,
                  },
                  dataType: "json",
                  headers: {'X-CSRFToken': csrftoken },
                  mode: 'same-origin',  
                  beforeSend: function () {
                     
                      $('#spinner').show();
                      $("#loading").addClass("loading")
                      
                  },
                  
                  success: function (ura_response) {
                     
                     const response = ura_response
                     let val = response[ Object.keys( response )[ 0 ] ]

                     if( Object.keys( val )[ 0 ] === "GetPRNResult" ) {
                        
                        console.log( '1',val[ 'GetPRNResult' ] )

                        tin_response = {
                           'status': response.GetPRNResponse.GetPRNResult.ErrorDesc,
                           'prn': response.GetPRNResponse.GetPRNResult.PRN,
                           'error_code': response.GetPRNResponse.GetPRNResult.ErrorCode,
                           'error_desc': response.GetPRNResponse.GetPRNResult.ErrorDesc,
                           'payment_expiry_date': response.GetPRNResponse.GetPRNResult.ExpiryDate,
                           'search_code': response.GetPRNResponse.GetPRNResult.SearchCode
                        }
                        console.log(tin_response)

                        if(tin_response.status === "SUCCESS"){
                           $("#prn").val(tin_response.prn)
                           $("#error_code").val(tin_response.error_code)
                           $("#rror_desc").val(tin_response.error_desc)
                           $("#payment_expiry_date").val(tin_response.payment_expiry_date)
                           $("#search_code").val(tin_response.search_code)
                           $('#prnError').html('');
                           console.log("now ")

                           

                        } else if (tin_response.status === "INVALID TIN") {
                              $("#tin").val('');
                              $('#gernerate_prn').prop('checked', false)
                              $("#prn").val('');
                              swal.fire(status);
                              $('.prnError').html('');
                        } else if(tin_response.status === "Invalid Length of TIN Entered, please try again"){
                              swal.fire(tin_response.status);
                              $("#prn").val("");
                              $("#error_code").val("");
                              $("#error_desc").val("");
                              $("#payment_expiry_date").val("");
                              $("#search_code").val("");
                              // $("<i class='tSx' class='green circular check mark icon'></i>" ).appendTo($("#Prn").parent());
                              $('.prnError').html('');
                              console.log("invalid tin number");
                        } else{
                              $("#prn").val("");
                              $("#error_code").val("");
                              $("#error_desc").val("");
                              $("#payment_expiry_date").val("");
                              $("#search_code").val("");
                              $("#tSx").remove();
                              $("<i id='tSx' class='red circular exclamation triangle icon'></i>").appendTo($("#Prn").parent());
                              $('.prnError ').html("Failed to generate PRN");
                              console.log("failed to generate PRN");

                        }
                        
                     } 
                     else {
                           console.log( '2', val )
                           
                           tin_response = {
                              'status': val.ErrorDesc,
                              'prn': val.PRN,
                              'ErrorCode': val.ErrorCode,
                              'ErrorDesc': val.ErrorDesc,
                              'ExpiryDate': val.ExpiryDate,
                              'SearchCode': val.SearchCode
                           }
                           console.log(tin_response)

                           if(tin_response.status === "SUCCESS"){
                              $("#prn").val(tin_response.prn)
                              $("#error_code").val(tin_response.ErrorCode)
                              $("#error_desc").val(tin_response.ErrorDesc)
                              $("#payment_expiry_date").val(tin_response.ExpiryDate)
                              $("#search_code").val(tin_response.SearchCode)
                              $('.prnError').html('');

                           } else if (tin_response.status === "INVALID TIN") {
                                 $("#tin").val('');
                                 $('#gernerate_prn').prop('checked', false)
                                 $("#prn").val('');
                                 swal.fire(status);
                                 $('.prnError').html('');
                           } else if(tin_response.status === "Invalid Length of TIN Entered, please try again"){
                                 swal.fire(tin_response.status);
                                 $("#prn").val("");
                                 $("#error_code").val("");
                                 $("#error_desc").val("");
                                 $("#payment_expiry_date").val("");
                                 $("#search_code").val("");
                                 // $("<i class='tSx' class='green circular check mark icon'></i>" ).appendTo($("#Prn").parent());
                                 $('.prnError').html('');
                                 console.log("invalid tin number");
                           } else{
                                 $("#prn").val("");
                                 $("#error_code").val("");
                                 $("#error_desc").val("");
                                 $("#payment_expiry_date").val("");
                                 $("#search_code").val("");
                                 $("#tSx").remove();
                                 $("<i id='tSx' class='red circular exclamation triangle icon'></i>").appendTo($("#Prn").parent());
                                 $('.prnError ').html("Failed to generate PRN");
                                 console.log("failed to generate PRN");

                           }
                           
                     }
   
                  },

                  error: function(response) {
                     console.log(response);
                     $('.prnError').html("Invalid PRN. Try later");
                   
                  },

                  complete: function (response) {
                      console.log(response);
                      $('#spinner').hide();
                      $("#loading").removeClass("loading")
                  },

            });

      } else{
         document.getElementById("prn").value = ''
         document.getElementById("error_code").value = ''
         document.getElementById("error_desc").value = ''
         document.getElementById("payment_expiry_date").value = ''
         document.getElementById("search_code").value = ''
      }    

   });
      


</script>



{% endblock content %}






